<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Quiz'Ops</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
 
  <!-- Manifest pour PWA -->
<link rel="manifest" href="manifest.json">
 
  <!-- Couleur de la barre de statut -->
<meta name="theme-color" content="#004aad">
 
  <!-- Pour iOS : rendre l'app installable -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
 
  <!-- Ic√¥nes iOS -->
<link rel="apple-touch-icon" href="icons/icon-192.png">
 
  <!-- Si tu veux changer l'ic√¥ne pour diff√©rents formats -->
<link rel="apple-touch-icon" sizes="152x152" href="icons/icon-192.png">
<link rel="apple-touch-icon" sizes="180x180" href="icons/icon-512.png">
  
  <style>
    :root {
      --bg:#f4f7fa; --text:#333; --card:#fff; --primary:#1a5276;
      --muted:#ecf0f1; --border:#d0d7de; --good:#28a745; --bad:#dc3545;
    }
    * { box-sizing: border-box; }
    body {
      font-family: Arial, Helvetica, sans-serif;
      background: var(--bg) url("https://images.unsplash.com/photo-1581094651181-3592e59b95a0?auto=format&fit=crop&w=1400&q=80") no-repeat center center fixed;
      background-size: cover; color: var(--text); margin: 0; padding: 0;
    }
    .overlay { background: rgba(255,255,255,0.95); min-height: 100vh; padding: 32px; }
    .container {
      max-width: 980px; margin: auto; background: var(--card); padding: 28px;
      border-radius: 16px; box-shadow: 0 6px 24px rgba(0,0,0,.12); animation: fadeIn 0.45s ease;
    }
    h1,h2 { color: var(--primary); text-align: center; margin: 0 0 12px; }
    .themes { display: grid; grid-template-columns: repeat(auto-fit,minmax(140px,1fr)); gap: 16px; margin-top: 20px; }
    .theme-button {
      background: var(--muted); border: 1px solid var(--border); border-radius: 12px;
      padding: 18px; cursor: pointer; font-size: 15px; font-weight: 600; text-align: center;
      transition: transform 0.18s, box-shadow 0.18s; user-select: none;
      min-height:110px; display:flex; flex-direction:column; justify-content:center; align-items:center;
    }
    .theme-button img { width: 48px; height: 48px; margin-bottom: 8px; }
    .theme-button:hover { transform: translateY(-4px); box-shadow: 0 6px 16px rgba(0,0,0,0.12); }

    .question { font-size: 1.2rem; margin: 14px 0; font-weight: 600; }
    .choice { display: flex; align-items: center; gap: 8px; padding: 12px 14px; margin-bottom: 12px;
      border: 1px solid var(--border); border-radius: 10px; background: #fff; cursor: pointer; transition: background 0.12s, transform 0.12s; }
    .choice:hover { background: #f4f6f8; transform: translateY(-2px); }
    .choice.correct { background-color: #d4edda !important; border-color: var(--good) !important; }
    .choice.wrong { background-color: #f8d7da !important; border-color: var(--bad) !important; }

    .submit-btn {
      display: inline-block; margin-top: 12px; background: var(--primary); color: white;
      padding: 10px 16px; border: none; border-radius: 10px; font-size: 0.98rem; cursor: pointer;
      transition: background 0.12s, transform 0.12s;
    }
    .submit-btn:hover { background: #154360; transform: scale(1.02); }

    .result { margin-top: 8px; font-weight: 700; }
    .explanation { margin-top: 10px; padding: 12px; border-left: 4px solid var(--primary);
      background: #f3f6f8; border-radius: 6px; line-height: 1.4; }

    .row { display:flex; gap:10px; flex-wrap:wrap; justify-content:center; }
    #nextBtn, #prevBtn, #backBtn {
      display: none; margin-top: 14px; padding: 10px 16px; border-radius: 10px;
    }
    #nextBtn { border: 1px solid var(--primary); background: var(--primary); color: #fff; }
    #prevBtn { border: 1px solid var(--border); background: var(--muted); }
    #backBtn { border: 1px solid var(--border); background: var(--muted); }

    .score { margin-top: 6px; text-align: center; color: #555; }
    .footer-note { margin-top: 18px; font-size: 12px; color: #666; text-align: center; }

    .progress-bar { margin: 12px 0; height: 20px; width: 100%; background: #eee; border-radius: 12px; overflow: hidden; }
    .progress-fill { height: 100%; width: 0%; background: var(--primary); text-align: center; color: #fff; font-size: 12px; line-height: 20px; transition: width 0.3s ease; }

    #login-container { text-align:center; }
    #login-container input {
      padding: 12px; width: 70%; max-width: 320px; margin-bottom: 12px;
      border: 1px solid var(--border); border-radius: 8px;
    }
    #login-container button {
      background: var(--primary); color: #fff; padding: 10px 16px; border: none; border-radius: 8px; cursor: pointer;
    }
    #logoutBtn { margin-top: 8px; background: transparent; color: #666; border: none; cursor: pointer; text-decoration: underline; }

    #progress-overview { margin-top: 24px; }
    .progress-card {
      border: 1px solid var(--border); border-radius: 12px; padding: 12px; margin-top: 10px; background: #fff;
    }
    .progress-mini { height: 10px; background:#eee; border-radius: 8px; overflow:hidden; }
    .progress-mini-fill { height: 100%; width: 0%; background: var(--primary); transition: width .3s; }
    .mini-row { display:flex; justify-content:space-between; font-size: 12px; color:#555; margin-top:6px; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    /* petites am√©liorations responsive */
    @media (max-width:520px){
      .theme-button img { width: 40px; height: 40px; }
      #login-container input { width: 90%; }
    }
  </style>
</head>
<body>
  <div class="overlay">
    <div class="container">

     <!-- === LOGIN PAGE === -->
      <div id="login-container">
        <h1>üîë Login to Quiz'Ops</h1>
        <p><button onclick="showSignup()" style="background:none;border:none;color:var(--primary);cursor:pointer;text-decoration:underline;font-size:0.9rem;">First connexion ? Subscribe</button></p>
        <p>Enter your email and password to start</p>
        <input type="email" id="emailInput" placeholder="your@email.com" />
        <br>
        <input type="password" id="passwordInput" placeholder="Password" />
        <br>
        <button onclick="login()">Login</button>
        <!-- Bouton mot de passe oubli√© -->
        <div style="margin-top:8px;">
          <button id="forgotID">Password forgot ?</button>
        </div>
        <div id="forgotIDForm" style="display:none;margin-top:10px">
          <input type="email" id="forgotEmail" placeholder="Your email" required />
          <button id="sendID">Send ID</button>
          <p id="forgotMessage"></p>
        </div>
      </div>

      <!-- SIGNUP PAGE -->
      <div id="signup-container" style="display:none; text-align:center;">
        <h1>üÜï First connexion ?</h1>
        <p>Subscribe with email and ID</p>
        <input type="email" id="signupEmail" placeholder="Your email" required />
        <br>
        <input type="text" id="signupID" placeholder="Your ID" required />
        <br>
        <button onclick="signup()">Subscribe</button>
        <p id="signupMessage"></p>
        <button onclick="showLogin()">‚¨Ö Already subscribe ? Please login</button>
      </div>

      <!-- === ADMIN PANEL === -->
      <div id="admin-panel" style="display:none;">
        <h1>üë®‚Äçüíª Moderator Dashboard</h1>
        <button id="logoutBtnAdmin" onclick="logout()">Logout</button>
        <p style="text-align:center">Select a user to view their quiz progress:</p>
        <div id="user-list" style="margin-top:20px;"></div>
        <div id="user-progress" style="margin-top:30px;"></div>
      </div>

      <!-- === THEME SELECTION === -->
      <div id="theme-selection" style="display:none;">
        <div style="display:flex;align-items:center;justify-content:space-between;">
          <h1>‚õΩ Quiz'Ops</h1>
          <button id="logoutBtn" onclick="logout()">Logout</button>
        </div>
        <p style="text-align:center">
          Pick a theme. Each quiz draws <b>10 random questions</b> from the theme‚Äôs question bank.
        </p>

        <!-- Dynamic themes grid -->
        <div class="themes"></div>

        <!-- Progress dashboard -->
        <div id="progress-overview"></div>
      </div>

      <!-- === QUIZ CONTAINER === -->
      <div id="quiz-container" style="display:none;">
        <h2 id="theme-title"></h2>
        <div class="progress-bar"><div class="progress-fill" id="progressFill">0%</div></div>
		<div id="timer" style="text-align:center; margin-bottom:10px; font-weight:600;"></div>
        <div class="score" id="scoreLine"></div>
        <div class="question" id="question"></div>
        <div class="choices" id="choices"></div>
        <div class="result" id="result"></div>
        <div class="explanation" id="explanation"></div>
        <div class="row">
          <button id="prevBtn" onclick="prevQuestion()">‚¨Ö Previous</button>
          <button id="nextBtn" onclick="nextQuestion()">Next ‚û°</button>
          <button id="backBtn" onclick="goBack()">‚¨Ö Back to Menu</button>
        </div>
        <div class="footer-note">Tip: you get a different set each time you launch a theme.</div>
      </div>

    </div>
  </div>

  <script>
    // ---------------------------
    // CONFIG
    // ---------------------------
    // Laisse vide si tu ne veux pas envoyer vers Power Automate pour l'instant
  function showSignup() {
    document.getElementById("login-container").style.display = "none";
    document.getElementById("signup-container").style.display = "block";
}

function showLogin() {
    document.getElementById("signup-container").style.display = "none";
    document.getElementById("login-container").style.display = "block";
}

  // === Power Automate Flow URL ===
const flowUrl = "https://default329e91b0e21f48fba071456717ecc2.8e.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/8529a06fdcc6401aaa54e12ccdf8053c/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=ZMFUE06qvb1Qjx-2UAwG47ivXUPZljA2ikv4TaMdVQE";
const flowUrlSignup = "https://default329e91b0e21f48fba071456717ecc2.8e.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/cb431fe6824e4af79ff1081e88adbcde/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=JJ-Qbs2tRRE5gFnpSBfUrVp6oPshyoZcKFEJ3CcVWvg";
const flow = "https://default329e91b0e21f48fba071456717ecc2.8e.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/cd72f3ad611140f4b40ee95952f496ac/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=U45wTZLPIBNCIHN1Jv8Uq1AmteCU1Bo6eLzz2TTmVIE"

function getUserIP() {
  // ‚ö†Ô∏è HTML ne peut pas obtenir l‚ÄôIP r√©elle sans backend.
  // Ici, tu peux mettre une valeur fixe ou appeler une API IP si autoris√©.
  return "127.0.0.1";
}

  // Utility: shuffle
  function shuffle(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

    // === QUESTION BANK ===
    const quizData = {
      cargo_docs: {
        title: "Cargo Documentation",
        questions: [
    { id: "id1", question: "Which document proves the ownership of a crude oil cargo?", 
      choices: ["Bill of Lading", "Certificate of Quality", "Charter Party", "NOR"], 
      correct: 0, 
      explanation: "The Bill of Lading is the legal document of cargo ownership." },
    { id: "id2", question: "Which document certifies the technical specifications of a product?", 
      choices: ["Certificate of Quality", "Bill of Lading", "Q88", "Charter Party"], 
      correct: 0, 
      explanation: "The Certificate of Quality details the product quality." },
    { id: "id3", question: "Which document contains details of time used for loading/discharging operations?", 
    choices: ["Statement of facts (SOF)", "NOR", "Charter Party", "Certificate of Quantity"], 
    correct: 0, 
    explanation: "The Statement of facts (SOF) records loading/discharging durations." },
    { id: "id4", question: "Which document is often required by banks under a Letter of Credit?", 
    choices: ["Bill of Lading", "Certificate of Quality", "NOR", "Q88"], 
    correct: 0, 
    explanation: "Banks usually require an original Bill of Lading for payment release." },
    { id: "id5", question: "Which document is essential for import customs?", 
      choices: ["Commercial Invoice", "Pumping Log", "Q88", "Certificate of Origin"], 
      correct: 3, 
      explanation: "The Certificate of Origin is required for customs clearance." },
    { 
    id: "id6", 
    question: "During discharge, the shore tank shows 500 MT less than ship‚Äôs ullage report. Which document will reconcile this difference?", 
    choices: ["Pumping Log", "Charter Party", "Surveyor Report", "Statement of Facts"], 
    correct: 2, 
    explanation: "The Surveyor Report reconciles ship vs. shore measurements and resolves cargo quantity disputes." 
  },
    { id: "id7", question: "What does NOR stand for in cargo documentation?", 
      choices: ["Notice of Readiness", "Nominal Oil Receipt", "Notice of Release", "None of the above"], 
      correct: 0, 
      explanation: "NOR = Notice of Readiness, declaring the vessel is ready to load/unload." },
    { id: "id8", question: "Which document describes a vessel's technical characteristics?", 
      choices: ["Q88", "Bill of Lading", "Certificate of Origin", "Cargo Manifest"], 
      correct: 0, 
      explanation: "The Q88 questionnaire details the tanker‚Äôs technical specs." },
    { id: "id9", question: "Which document summarizes all loaded products?", 
      choices: ["Cargo Manifest", "Certificate of Analysis", "Invoice", "Bunker Receipt"], 
      correct: 0, 
      explanation: "The Cargo Manifest lists all cargoes on board." },
	{ id: "id10", question: "Which document summarizes the commercial terms agreed between charterer and owner?", 
      choices: ["Charter Party", "Bill of Lading", "Statement of Facts", "Cargo Manifest"], 
      correct: 0, 
      explanation: "The Charter Party is the contract between shipowner and charterer detailing agreed terms." }
  ]
},

crude_types_specs: { 
    title: "Crude Oil Types & Specs", 
    questions: [] 
  },
  refined_products: { 
    title: "Refined Products (Gasoline, Diesel, Jet A1, Fuel Oil)", 
    questions: [] 
  },
  trading_market: { 
    title: "Trading & Market Fundamentals", 
    questions: [] 
  },
  pricing_contracts: { 
    title: "Pricing & Contracts", 
    questions: [] 
  },
  logistics_shipping: { 
    title: "Logistics & Shipping Operations", 
    questions: [] 
  },
  insurance_risk: { 
    title: "Insurance & Risk Management", 
    questions: [] 
  },
  refining_blending: { 
    title: "Refining & Blending", 
    questions: [] 
  },
  specialty_products: { 
    title: "LPG, VGO, Bitumen, and Other Specialty Products", 
    questions: [] 
  },
  regulations_compliance: { 
    title: "Trading Regulations & Compliance", 
    questions: [] 
  },
  quality_testing: { 
    title: "Quality Control & Testing", 
    questions: [] 
  },
  operations_coordination: { 
    title: "Operations & Stakeholder Coordination", 
    questions: [] 
  }
};

    // ---------------------------
    // Unlock logic
    // ---------------------------
    function isThemeUnlocked(theme) {
      if (theme === "cargo_docs") return true; // disponible d√®s le d√©part

      // ordre des th√®mes (d√©blocage mensuel √† partir de Jan 2026)
      const themesOrder = Object.keys(quizData).filter(t => t !== "cargo_docs");
      const start = new Date(2026, 0, 1); // 1 Jan 2026
      const now = new Date();

      // mois pass√©s depuis start (0 pour Jan 2026)
      const monthDiff = (now.getFullYear() - start.getFullYear()) * 12 + (now.getMonth() - start.getMonth());

      if (monthDiff < 0) return false;
      if (monthDiff >= themesOrder.length) return false;

      return themesOrder[monthDiff] === theme;
    }

    // ---------------------------
    // UI / Themes grid
    // ---------------------------
    function renderThemesGrid() {
      const grid = document.querySelector(".themes");
      if (!grid) return;
      grid.innerHTML = "";

      const icons = {
  cargo_docs: "https://img.icons8.com/fluency/96/document.png",
  crude_types_specs: "https://img.icons8.com/color/96/oil.png",
  refined_products: "https://img.icons8.com/color/96/fuel.png",
  trading_market: "https://img.icons8.com/color/96/combo-chart.png",
  pricing_contracts: "https://img.icons8.com/color/96/contract.png",
  logistics_shipping: "https://img.icons8.com/color/96/cargo-ship.png",
  insurance_risk: "https://img.icons8.com/color/96/shield.png",
  refining_blending: "https://img.icons8.com/color/96/factory.png",
  specialty_products: "https://img.icons8.com/color/96/laboratory.png",
  regulations_compliance: "https://img.icons8.com/color/96/law.png",
  quality_testing: "https://img.icons8.com/color/96/test-tube.png",
  operations_coordination: "https://img.icons8.com/color/96/teamwork.png"
};

      Object.keys(quizData).forEach(t => {
        const unlocked = isThemeUnlocked(t);
        const total = quizData[t].questions.length;
        const solved = getSolvedCount(t);
        const pct = total ? Math.round((solved / total) * 100) : 0;
        const icon = unlocked ? (icons[t] || icons['cargo_docs']) : "https://img.icons8.com/ios-filled/96/lock.png";

        const div = document.createElement("div");
        div.className = "theme-button";
        div.innerHTML = `
          <img src="${icon}" alt="${quizData[t].title}"/><br>
          ${quizData[t].title}
          <div class="progress-mini" style="margin-top:10px;width:100%;">
            <div class="progress-mini-fill" style="width:${pct}%"></div>
          </div>
          <div class="mini-row" style="width:100%;">
            <span style="font-size:12px">${solved}/${total || 0} solved</span>
            <span style="font-size:12px">${pct}%</span>
          </div>
        `;

        if (unlocked) div.onclick = () => startQuiz(t);
        else {
          div.style.opacity = "0.55";
          div.style.cursor = "not-allowed";
          // tooltip simple
          div.title = "Th√®me verrouill√© ‚Äî se d√©bloque progressivement √† partir de Jan 2026";
        }
        grid.appendChild(div);
      });
    }

    // ---------------------------
/* ========= State ========= */
  let currentTheme = "";
  let questionIndex = 0;
  let selectedSet = [];
  let score = 0;
  let answersHistory = {}; // { [qIndex]: { selected:number[], isCorrect:boolean, explanation:string, id?:string } }
  let currentUser = null;
let timerInterval = null;
let timeLeft = 10;

  /* ========= Login ========= */
  
async function login() {
    const email = document.getElementById("emailInput").value.trim().toLowerCase();
    const password = document.getElementById("passwordInput").value.trim();

    if (!email || !email.includes("@")) {
        alert("Please enter a valid email");
        return;
    }
    if (!password) {
        alert("Please enter your ID");
        return;
    }

    // === V√©rifier si c'est l'admin ===
    if (email === "admin@quiz.com" && password === "admin123") {
        currentUser = "admin";
        document.getElementById("login-container").style.display = "none";
        document.getElementById("admin-panel").style.display = "block";
        renderUserList();
        return;
    }

 // === V√©rification via Flow Login ===
    try {
        const res = await fetch(flowUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, id: password })
        });
        const text = await res.text();
        console.log("Login Flow response:", text);

        if (text.includes("Login r√©ussi")) {
            // ‚úÖ Login ok
            currentUser = email;
            localStorage.setItem("quizUser", currentUser);
            document.getElementById("login-container").style.display = "none";
            document.getElementById("theme-selection").style.display = "block";
            renderThemesGrid();
            loadProgressOverview();
        } else {
            // ‚ö° Si login √©choue, v√©rifier si on a un user temporaire stock√©
            const tempUser = JSON.parse(localStorage.getItem("tempUser") || "null");
            if (tempUser && tempUser.email === email && tempUser.id === password) {
                currentUser = email;
                localStorage.setItem("quizUser", currentUser);
                document.getElementById("login-container").style.display = "none";
                document.getElementById("theme-selection").style.display = "block";
                renderThemesGrid();
                loadProgressOverview();
            } else {
                alert("‚ùå Email ou ID incorrect. If first connexion, please subscribe.");
            }
        }
    } catch (err) {
        console.error("‚ùå Login error:", err);
        alert("‚ùå Unable to login. Please check your connection or try later.");
    }
}

 function logout() {
 // üî¥ Stop le timer en cours
  stopTimer();

  // üî¥ R√©initialise l'affichage du timer
  const timerEl = document.getElementById("timer");
  if (timerEl) timerEl.textContent = "";
  
  try { localStorage.removeItem("quizUser"); } catch(e) {}
  currentUser = null;
  document.getElementById("theme-selection").style.display = "none";
  document.getElementById("quiz-container").style.display = "none";
  document.getElementById("admin-panel").style.display = "none";
  document.getElementById("login-container").style.display = "block";
}

  window.addEventListener("DOMContentLoaded", () => {
    let saved = null;
    try { saved = localStorage.getItem("quizUser"); } catch(e) {}
    if (saved) {
      currentUser = saved;
      document.getElementById("login-container").style.display = "none";
      document.getElementById("theme-selection").style.display = "block";
      renderThemesGrid();
      loadProgressOverview();
    }
  });

  /* ========= Persistent progress (unique solved) ========= */
  function getUserProgress() {
    try {
      return JSON.parse(localStorage.getItem("progress_" + currentUser) || "{}");
    } catch(e) { return {}; }
  }
  function setUserProgress(data) {
    try {
      localStorage.setItem("progress_" + currentUser, JSON.stringify(data));
    } catch(e) {}
  }
  function markQuestionAsSolved(theme, qid) {
    if (!qid) return;
    const data = getUserProgress();
    if (!data[theme]) data[theme] = { solved: [] };
    if (!Array.isArray(data[theme].solved)) data[theme].solved = [];
    if (!data[theme].solved.includes(qid)) {
      data[theme].solved.push(qid);
      setUserProgress(data);
    }
  }
  function getSolvedCount(theme) {
    const data = getUserProgress();
    return data[theme]?.solved?.length || 0;
  }


  /* ========= Progress overview (cards list) ========= */
  function loadProgressOverview() {
    const overview = document.getElementById("progress-overview");
    if (!overview) return;
    const themes = Object.keys(quizData);

    let html = '<h3 style="text-align:center;margin-top:24px;">Your Progress</h3>';
    html += themes.map(t => {
      const total = quizData[t].questions.length;
      const solved = getSolvedCount(t);
      const pct = total ? Math.round((solved / total) * 100) : 0;
      return `
        <div class="progress-card">
          <div style="font-weight:700;">${quizData[t].title}</div>
          <div class="progress-mini">
            <div class="progress-mini-fill" style="width:${pct}%;"></div>
          </div>
          <div class="mini-row">
            <span>${solved}/${total || 0} solved</span>
            <span>${pct}%</span>
          </div>
        </div>`;
    }).join("");

    overview.innerHTML = html;
  }

  /* ========= Listes of users ========= */
  
function renderUserList() {
  let users = {};
  try { users = JSON.parse(localStorage.getItem("quizUsers") || "{}"); } catch(e) {}

  const userListDiv = document.getElementById("user-list");
  userListDiv.innerHTML = "";

  const emails = Object.keys(users);
  if (emails.length === 0) {
    userListDiv.innerHTML = "<p>No registered users yet.</p>";
    return;
  }

  emails.forEach(email => {
    if (email === "admin@quiz.com") return; // on ne liste pas l‚Äôadmin
    const btn = document.createElement("button");
    btn.textContent = email;
    btn.style.display = "block";
    btn.style.margin = "6px auto";
    btn.style.padding = "8px 12px";
    btn.style.borderRadius = "8px";
    btn.style.border = "1px solid #ccc";
    btn.onclick = () => showUserProgress(email);
    userListDiv.appendChild(btn);
  });
}

function showUserProgress(email) {
  const container = document.getElementById("user-progress");

  let data = {};
  try { data = JSON.parse(localStorage.getItem("progress_" + email) || "{}"); } catch(e) {}

  let html = `<h3>üìä Progress for ${email}</h3>`;

  const themes = Object.keys(quizData);
  if (themes.length === 0) {
    html += "<p>No themes available.</p>";
  } else {
    html += themes.map(t => {
      const total = quizData[t].questions.length;
      const solved = data[t]?.solved?.length || 0;
      const pct = total ? Math.round((solved / total) * 100) : 0;
      return `
        <div class="progress-card">
          <div style="font-weight:700;">${quizData[t].title}</div>
          <div class="progress-mini">
            <div class="progress-mini-fill" style="width:${pct}%;"></div>
          </div>
          <div class="mini-row">
            <span>${solved}/${total || 0} solved</span>
            <span>${pct}%</span>
          </div>
        </div>`;
    }).join("");
  }

  container.innerHTML = html;
}

  /* ========= Email et ID ========= */

async function signup() {
    const email = document.getElementById("signupEmail").value.trim().toLowerCase();
    const id = document.getElementById("signupID").value.trim();

    if (!email || !email.includes("@") || !id) {
        alert("‚ùå Please enter a valid email and ID.");
        return;
    }


try {
        const res = await fetch(flowUrlSignup, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, id })
        });

        const data = await res.json();
        console.log("Signup Flow response:", data);

        if (data?.status === 200 || data?.status === 400) {
            // ‚úÖ Stockage imm√©diat local pour login instantan√©
            localStorage.setItem("tempUser", JSON.stringify({ email, id }));
            alert("‚úÖ " + data.message);
            showLogin();
        } else {
            alert("‚ùå Technical error during signup. Please try again later.");
        }
    } catch (err) {
        console.error("‚ùå Signup error:", err);
        alert("‚ùå Technical error during signup. Please try again later.");
    }
}

// === Mot de passe oubli√© ===

// Afficher/cacher le formulaire "Mot de passe oubli√©"
document.getElementById("forgotID").onclick = () => {
    const form = document.getElementById("forgotIDForm");
    form.style.display = form.style.display === "none" ? "block" : "none";
}

  document.getElementById("sendID").onclick = () => {
    const email = document.getElementById("forgotEmail").value.trim().toLowerCase();
    if(!email || !email.includes("@")) { 
      alert("Enter a valid email"); 
      return; 
    }

    fetch("https://default329e91b0e21f48fba071456717ecc2.8e.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/458482932c2546798bc331d62bcd9579/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=OacmhYAvpw_QjrCTJvpr0T-2Rgp2PBbR5HbxS5NVm3c", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email })
    })
    .then(res => {
      if(res.status === 200) alert("‚úÖ Email sent successfully!");
      else if(res.status === 400) alert("‚ùå Email does not exist");
      else alert("‚ùå Error: " + res.status);
    })
    .catch(err => console.error("‚ùå Fetch error:", err));
  }



  /* ========= Quiz engine ========= */
 
     function startQuiz(theme) {
      if (!currentUser) { alert("Please login first."); return; }
      if (!quizData[theme]) { alert("Theme not found."); return; }

      const bank = quizData[theme].questions.slice();
      if (bank.length === 0) {
        // show empty message inside quiz container
        document.getElementById("theme-selection").style.display = "none";
        document.getElementById("quiz-container").style.display = "block";
        document.getElementById("theme-title").textContent = "Theme: " + quizData[theme].title;
        document.getElementById("scoreLine").textContent = "";
        document.getElementById("question").textContent = "‚ö†Ô∏è No questions configured for this theme yet.";
        document.getElementById("choices").innerHTML = "";
        document.getElementById("result").textContent = "";
        document.getElementById("explanation").textContent = "";
        document.getElementById("prevBtn").style.display = "none";
        document.getElementById("nextBtn").style.display = "none";
        document.getElementById("backBtn").style.display = "inline-block";
        const fill = document.getElementById("progressFill");
        if (fill) { fill.style.width = "0%"; fill.textContent = "0%"; }
        return;
      }

      currentTheme = theme;
      questionIndex = 0;
      score = 0;
      answersHistory = {};

      shuffle(bank);
      selectedSet = bank.slice(0, Math.min(10, bank.length));

      document.getElementById("theme-selection").style.display = "none";
      document.getElementById("quiz-container").style.display = "block";
      document.getElementById("theme-title").textContent = "Theme: " + quizData[theme].title;

      updateScoreLine();
      updateTopProgressBar();
      showQuestion();
    }

  function updateScoreLine() {
    const totalQ = selectedSet.length || 0;
    document.getElementById("scoreLine").textContent =
      `Question ${questionIndex + 1} / ${totalQ} ‚Ä¢ Score: ${score}`;
  }

  // barre du haut = progression cumul√©e (questions uniques r√©solues) du th√®me
  function updateTopProgressBar() {
    if (!currentTheme) return;
    const total = quizData[currentTheme].questions.length;
    const solved = getSolvedCount(currentTheme);
    const percent = total ? Math.round((solved / total) * 100) : 0;
    const fill = document.getElementById("progressFill");
    if (fill) {
      fill.style.width = percent + "%";
      fill.textContent = percent + "%";
    }
  }

 function showQuestion() {
  const q = selectedSet[questionIndex];
  const choicesDiv = document.getElementById("choices");
  if (!q) {
    document.getElementById("question").textContent = "‚ö†Ô∏è Question not found!";
    choicesDiv.innerHTML = "";
    document.getElementById("result").textContent = "";
    document.getElementById("explanation").textContent = "";
    document.getElementById("nextBtn").style.display = "none";
    document.getElementById("prevBtn").style.display = "none";
    return;
  }

  document.getElementById("question").textContent = q.question;
  choicesDiv.innerHTML = "";
  document.getElementById("result").textContent = "";
  document.getElementById("explanation").textContent = "";
  document.getElementById("nextBtn").style.display = "none";
  document.getElementById("prevBtn").style.display = questionIndex > 0 ? "inline-block" : "none";
  document.getElementById("backBtn").style.display = "inline-block";

  const multiple = Array.isArray(q.correct);
  q.choices.forEach((choice, idx) => {
    const wrapper = document.createElement("label");
    wrapper.className = "choice";
    const input = document.createElement("input");
    input.type = multiple ? "checkbox" : "radio";
    input.name = "answer";
    input.value = idx;
    const text = document.createElement("span");
    text.textContent = choice;
    wrapper.appendChild(input);
    wrapper.appendChild(text);
    choicesDiv.appendChild(wrapper);
  });

  const checkBtn = document.createElement("button");
  checkBtn.textContent = "Submit Answer";
  checkBtn.className = "submit-btn";
  checkBtn.onclick = () => { stopTimer(); checkAnswer(); };
  choicesDiv.appendChild(checkBtn);

  if (answersHistory[questionIndex]) {
    restoreAnswerState();
    stopTimer();
    document.getElementById("timer").textContent = "";
  } else {
    startTimer();
  }

  updateScoreLine();
  updateTopProgressBar();
}

function startTimer() {
  stopTimer(); // √©viter un double timer
  timeLeft = 10;
  document.getElementById("timer").textContent = `‚è≥ Time left: ${timeLeft}s`;

  timerInterval = setInterval(() => {
    timeLeft--;
    document.getElementById("timer").textContent = `‚è≥ Time left: ${timeLeft}s`;

    if (timeLeft <= 0) {
      stopTimer();
      autoFail();
    }
  }, 1000);
}

function stopTimer() {
  if (timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
  }
}

function autoFail() {
  const q = selectedSet[questionIndex];
  const wrappers = document.querySelectorAll(".choice");
  const inputs = document.querySelectorAll("input[name='answer']");
  inputs.forEach(el => el.disabled = true);

  // marquer la bonne r√©ponse en vert
  if (!Array.isArray(q.correct)) {
    wrappers.forEach((wrapper, i) => {
      if (i === q.correct) wrapper.classList.add("correct");
    });
  } else {
    wrappers.forEach((wrapper, i) => {
      if (q.correct.includes(i)) wrapper.classList.add("correct");
    });
  }

document.getElementById("nextBtn").style.display = "inline-block";

  // afficher mauvais r√©sultat
  const answerTxt = Array.isArray(q.correct)
    ? q.correct.map(i => q.choices[i]).join(", ")
    : q.choices[q.correct];
  document.getElementById("result").textContent = "‚è∞ Time's up! Correct: " + answerTxt;
  document.getElementById("result").style.color = "red";
  document.getElementById("explanation").textContent = q.explanation || "";

  answersHistory[questionIndex] = { selected: [], isCorrect: false, explanation: q.explanation, id: q.id };

  // envoyer comme incorrect
  sendAnswerToFlow(q, [], false);

  // afficher bouton Next
  document.getElementById("nextBtn").style.display = "inline-block";
}

function checkAnswer() {
  const q = selectedSet[questionIndex];
  const wrappers = document.querySelectorAll(".choice");
  const inputs = document.querySelectorAll("input[name='answer']");
  
  // R√©cup√©rer les r√©ponses s√©lectionn√©es
  let selected = Array.from(inputs)
    .filter(el => el.checked)
    .map(el => parseInt(el.value));

  if (selected.length === 0) { 
    alert("Select an answer"); 
    return; 
  }

  // Bloquer les inputs
  inputs.forEach(el => el.disabled = true);

  // V√©rifier la r√©ponse
  let isCorrect = false;
  if (!Array.isArray(q.correct)) {
    wrappers.forEach((wrapper, i) => {
      if (i === q.correct) wrapper.classList.add("correct");
      else if (selected.includes(i)) wrapper.classList.add("wrong");
    });
    if (selected.length === 1 && selected[0] === q.correct) isCorrect = true;
  } else {
    const correctSorted = [...q.correct].sort((a,b)=>a-b);
    const selectedSorted = [...selected].sort((a,b)=>a-b);
    wrappers.forEach((wrapper, i) => {
      if (q.correct.includes(i)) wrapper.classList.add("correct");
      else if (selected.includes(i)) wrapper.classList.add("wrong");
    });
    if (JSON.stringify(selectedSorted) === JSON.stringify(correctSorted)) isCorrect = true;
  }

  // Affichage r√©sultat
  if (isCorrect) {
    score++;
    document.getElementById("result").textContent = "‚úÖ Correct!";
    document.getElementById("result").style.color = "green";
  } else {
    const answerTxt = Array.isArray(q.correct)
      ? q.correct.map(i => q.choices[i]).join(", ")
      : q.choices[q.correct];
    document.getElementById("result").textContent = "‚ùå Wrong. Correct: " + answerTxt;
    document.getElementById("result").style.color = "red";
  }

  document.getElementById("explanation").textContent = q.explanation || "";

  // M√©morise l'√©tat dans la session
  answersHistory[questionIndex] = { selected, isCorrect, explanation: q.explanation, id: q.id };

  // ‚úÖ Envoi imm√©diat au Flow
  sendAnswerToFlow(q, selected, isCorrect);

  // Toujours r√©v√©ler le bouton Next
  const nb = document.getElementById("nextBtn");
  if (nb) nb.style.display = "inline-block";

  // Mettre √† jour le score affich√©
  updateScoreLine();
}

 stopTimer(); // ‚è±Ô∏è stoppe et r√©cup√®re le temps de cette question
 
/* ========= Fonction pour envoyer au Flow avec debug ========= */
function sendAnswerToFlow(q, selected, isCorrect) {
  if (!currentUser || !currentTheme) return;

  const selectedAnswers = Array.isArray(selected)
    ? selected.map(i => q.choices[i]).join(", ")
    : q.choices[selected];

  const payload = {
    email: currentUser,
    IP: getUserIP(),           // tu peux remplacer par navigator.userAgent ou vrai IP si dispo
    Theme: currentTheme,
    question: q.question,
    reponse: selectedAnswers,
    resultat: isCorrect ? "Correct" : "Incorrect"
  };

  console.log("üì§ Payload envoy√© au Flow:", payload); // debug JSON

  fetch(flow, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  })
  .then(res => {
    if (res.status === 202 || res.status === 200) {
      console.log("‚úÖ Donn√©es envoy√©es au Flow avec succ√®s");
    } else {
      console.error("‚ùå Erreur Flow:", res.status, res.statusText);
    }
  })
  .catch(err => console.error("‚ùå Erreur fetch:", err));
}
	

  function restoreAnswerState() {
    const q = selectedSet[questionIndex];
    const saved = answersHistory[questionIndex];
    if (!saved) return;

    const wrappers = document.querySelectorAll(".choice");
    const inputs = document.querySelectorAll("input[name='answer']");
    inputs.forEach(el => {
      if (saved.selected.includes(parseInt(el.value))) el.checked = true;
      el.disabled = true;
    });

    wrappers.forEach((wrapper, i) => {
      if (Array.isArray(q.correct)) {
        if (q.correct.includes(i)) wrapper.classList.add("correct");
        else if (saved.selected.includes(i)) wrapper.classList.add("wrong");
      } else {
        if (i === q.correct) wrapper.classList.add("correct");
        else if (saved.selected.includes(i)) wrapper.classList.add("wrong");
      }
    });

    document.getElementById("result").textContent = saved.isCorrect ? "‚úÖ Correct!" : "‚ùå Wrong.";
    document.getElementById("result").style.color = saved.isCorrect ? "green" : "red";
    document.getElementById("explanation").textContent = saved.explanation || "";

    const nb = document.getElementById("nextBtn");
    if (nb) nb.style.display = "inline-block";
  }

  function commitSessionSolved() {
    // Marque comme ‚Äúsolved‚Äù uniquement les questions r√©pondues justes une fois le quiz termin√©
    try {
      const idsToCommit = [];
      Object.keys(answersHistory).forEach(k => {
        const rec = answersHistory[k];
        if (rec?.isCorrect && rec?.id) idsToCommit.push(rec.id);
      });
      // d√©doublonne
      const unique = Array.from(new Set(idsToCommit));
      unique.forEach(qid => markQuestionAsSolved(currentTheme, qid));
    } catch(e) {
      // ne bloque pas l‚ÄôUI
    }
  }

  function nextQuestion() {
    if (questionIndex < selectedSet.length - 1) {
      questionIndex++;
      showQuestion();
    } else {
      // Fin de session
      commitSessionSolved();          // <-- cumulatif unique appliqu√© ici
      updateTopProgressBar();         // met √† jour la barre du haut
      renderThemesGrid();             // met √† jour la grid d‚Äôaccueil
      loadProgressOverview();         // met √† jour les cartes

      document.getElementById("question").textContent = "üéâ Quiz completed!";
      document.getElementById("choices").innerHTML = "";
      document.getElementById("result").textContent = `Final Score: ${score}/${selectedSet.length}`;
      document.getElementById("explanation").textContent = "";
      document.getElementById("nextBtn").style.display = "none";
      document.getElementById("prevBtn").style.display = "inline-block";
      document.getElementById("backBtn").style.display = "inline-block";

      // retour menu auto (facultatif)
      setTimeout(() => { goBack(); }, 1000);
    }
  }

  function prevQuestion() {
    if (questionIndex > 0) {
      questionIndex--;
      showQuestion();
    }
  }

  function goBack() {
    document.getElementById("quiz-container").style.display = "none";
    document.getElementById("theme-selection").style.display = "block";
    renderThemesGrid();
    loadProgressOverview();

    // stop timer et reset affichage
    stopTimer();
    const timerEl = document.getElementById("timer");
    if (timerEl) timerEl.textContent = "";

    // reset barre visuelle de l‚ÄôUI du quiz (facultatif)
    const fill = document.getElementById("progressFill");
    if (fill) { fill.style.width = "0%"; fill.textContent = "0%"; }
}
  
 function sendTestRow() {
  fetch(flowUrl, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({
  Email: "test@example.com",
  IP: "127.0.0.1",
  Theme: "TestTheme",
  Question: "Test question",
  Reponse: "Test answer",
  Resultat: "Correct"
})
  })
  .then(res => alert("Test row sent! Status " + res.status))
  .catch(err => console.error("‚ùå Flow error", err));
}

if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js")
    .then(() => console.log("‚úÖ Service Worker registered"))
    .catch(err => console.error("‚ùå Service Worker error", err));
}
  </script>
</body>
</html>


